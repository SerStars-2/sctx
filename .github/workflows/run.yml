name: Run SCTX-Converter and Retrieve PNG

on:
  workflow_dispatch:
    inputs:
      sctx-url:
        description: 'URL of the .sctx file'
        required: true
        default: ''
      discord-id:
        description: 'Discord user ID to mention'
        required: true
        type: number

jobs:
  decode-sctx:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download SCTX-Converter
      run: |
        curl -L -o SctxConverter.exe https://github.com/Daniil-SV/SCTX-Converter/releases/latest/download/SctxConverter.exe

    - name: Extract filename from URL (PowerShell)
      id: extract_filename
      run: |
        $url = "${{ github.event.inputs.sctx-url }}"
        Write-Host "Full URL: $url"
        
        # Extract filename without query parameters
        $filename = [System.IO.Path]::GetFileNameWithoutExtension(($url -split '\?')[0])
        Write-Host "Extracted filename: $filename"

        echo "filename=$filename" | Out-File -FilePath $env:GITHUB_ENV -Append

    - name: Download .sctx file
      run: |
        $url = "${{ github.event.inputs.sctx-url }}"
        $output = "${{ env.filename }}.sctx"
        Write-Host "Downloading from: $url"
        
        # Download using Invoke-WebRequest to avoid PowerShell's '&' issue
        Invoke-WebRequest -Uri $url -OutFile $output

    - name: Convert .sctx to .png
      run: |
        .\SctxConverter.exe decode "${{ env.filename }}.sctx" --texture-only
      shell: cmd

    - name: Verify PNG file existence
      run: |
        echo "Checking if PNG file exists..."
        if (Test-Path "${{ env.filename }}.png") {
          Write-Host "✅ PNG file exists!"
        } else {
          Write-Host "❌ PNG file NOT found!"
          exit 1
        }

    - name: Post PNG to Discord
      uses: tsickert/discord-webhook@v6.0.0
      with:
        webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
        file: "${{ env.filename }}.png"
        content: "<@${{ github.event.inputs.discord-id }}>"

    - name: If Failed to Convert
      uses: sarisia/actions-status-discord@v1.15.1
      if: failure()
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      with:
        nodetail: true
        nofail: false
        title: "Failed to convert `${{ env.filename }}.sctx` to PNG"
        content: "<@${{ github.event.inputs.discord-id }}>"
