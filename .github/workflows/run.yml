name: Run SCTX-Converter and Retrieve PNG

on:
  workflow_dispatch:
    inputs:
      sctx-url:
        description: 'URL of the .sctx file'
        required: true
        default: ''
      discord-id:
        description: 'Discord user ID to mention'
        required: true
        type: number

jobs:
  decode-sctx:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download SCTX-Converter
      run: |
        curl -L -o SctxConverter.exe https://github.com/Daniil-SV/SCTX-Converter/releases/latest/download/SctxConverter.exe

    - name: Extract filename from URL (PowerShell)
      id: extract_filename
      run: |
        $url = "${{ github.event.inputs.sctx-url }}"
        Write-Host "URL: $url"
        $filename = [System.IO.Path]::GetFileNameWithoutExtension($url)
        Write-Host "Extracted filename: $filename"
        echo "::set-output name=filename::$filename"

    - name: Check extracted filename
      run: |
        echo "Extracted filename: ${{ steps.extract_filename.outputs.filename }}"

    - name: Download .sctx file
      run: |
        echo "Downloading file from URL: ${{ github.event.inputs.sctx-url }}"
        curl -L -o "${{ steps.extract_filename.outputs.filename }}.sctx" ${{ github.event.inputs.sctx-url }}

    - name: Convert .sctx to .png
      run: |
        .\SctxConverter.exe decode "${{ steps.extract_filename.outputs.filename }}.sctx" --texture-only
      shell: cmd

    - name: Verify PNG file existence
      run: |
        echo "Checking PNG file existence"
        if (Test-Path "${{ steps.extract_filename.outputs.filename }}.png") {
          Write-Host "PNG file exists!"
        } else {
          Write-Host "PNG file does NOT exist!"
        }

    - name: Upload PNG file
      uses: actions/upload-artifact@v3
      with:
        name: decoded-png
        path: |
          ${{ steps.extract_filename.outputs.filename }}.png

    - name: List files in the directory
      run: |
        echo "Listing files in the directory"
        ls

    - name: Post PNG to Discord
      shell: bash
      run: |
        echo "Posting to Discord..."
        if [ -f "${{ steps.extract_filename.outputs.filename }}.png" ]; then
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: multipart/form-data" \
            -F "content=<@${{ github.event.inputs.discord-id }}>" \
            -F "file=@${{ steps.extract_filename.outputs.filename }}.png"
        else
          echo "File not found: ${{ steps.extract_filename.outputs.filename }}.png"
          exit 1
        fi