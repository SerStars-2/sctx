name: Run SCTX-Converter and Retrieve PNG

on:
  workflow_dispatch:
    inputs:
      sctx-url:
        description: 'URL of the .sctx file'
        required: true
        default: ''
      discord-id:
        description: 'Discord user ID to mention'
        required: true
        type: number

jobs:
  decode-sctx:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download SCTX-Converter
      run: |
        curl -L -o SctxConverter.exe https://github.com/Daniil-SV/SCTX-Converter/releases/latest/download/SctxConverter.exe

    - name: Extract filename from URL (PowerShell)
      id: extract_filename
      run: |
        $url = "${{ github.event.inputs.sctx-url }}"
        Write-Host "URL: $url"
        $filename = [System.IO.Path]::GetFileNameWithoutExtension($url)
        Write-Host "Extracted filename: $filename"
        echo "FILENAME=$filename" >> $GITHUB_ENV

    - name: Verify filename in environment
      run: |
        echo "filename in environment: ${{ env.FILENAME }}"

    - name: Download .sctx file
      run: |
        echo "Downloading file: ${{ github.event.inputs.sctx-url }}"
        curl -L -o ${{ env.FILENAME }}.sctx ${{ github.event.inputs.sctx-url }}
      
    - name: Run SctxConverter
      run: |
        echo "Running SctxConverter with: ${{ env.FILENAME }}.sctx"
        .\SctxConverter.exe decode ${{ env.FILENAME }}.sctx --texture-only
      shell: cmd

    - name: List files in the current directory
      run: |
        dir

    - name: Verify file existence before uploading
      run: |
        if (Test-Path ${{ env.FILENAME }}.sctx.png) {
          echo "File exists: ${{ env.FILENAME }}.sctx.png"
        } else {
          echo "File does NOT exist: ${{ env.FILENAME }}.sctx.png"
        }

    - name: Upload PNG file
      uses: actions/upload-artifact@v3
      with:
        name: decoded-png
        path: |
          ${{ env.FILENAME }}.sctx.png

    - name: Post PNG to Discord
      run: |
        $filePath = "${{ env.FILENAME }}.sctx.png"
        Write-Host "Posting to Discord with file: $filePath"
        $discordWebhookUrl = "${{ secrets.DISCORD_WEBHOOK_URL }}"
        $discordMessage = "<@${{ github.event.inputs.discord-id }}>"
        
        # Define headers and form data
        $headers = @{
          "Content-Type" = "multipart/form-data"
        }

        $formFields = @{
          content = $discordMessage
          file    = Get-Item $filePath
        }

        # Use Invoke-RestMethod to post the data to Discord
        $response = Invoke-RestMethod -Uri $discordWebhookUrl -Method Post -Headers $headers -Form $formFields
        Write-Host "Response: $response"
